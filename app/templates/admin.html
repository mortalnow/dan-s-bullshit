{% extends "base.html" %}
{% block content %}
<section class="hero">
  <h2>{% if is_admin %}Admin Dashboard{% else %}User Dashboard{% endif %}</h2>
  <p><span style="display: block;">Welcome, {{ admin_name }} ({{ admin_email }}).</span><span
      style="display: block;">Monitoring the pulse of the bullshit.</span></p>
  <div class="badge-row">
    {% if is_admin %}
      <a href="/admin?mode=archive" class="badge {% if mode == 'archive' %}alt{% endif %}" style="border-bottom: 0;">Full
        Archive</a>
      <a href="/admin?mode=moderation" class="badge {% if mode == 'moderation' %}alt{% endif %}"
        style="border-bottom: 0;">Moderation Mode</a>
      <a href="/admin?mode=users" class="badge {% if mode == 'users' %}alt{% endif %}" style="border-bottom: 0;">User
        Moderation</a>
    {% endif %}
    <form method="post" action="/admin/logout" style="display: inline;">
      <button type="submit" class="badge"
        style="border-bottom: 0; cursor: pointer; background: var(--hot); color: #fff;">Logout</button>
    </form>
  </div>
</section>

<section class="grid">
  {% if not is_admin %}
    <div class="card">
      <h3>Welcome!</h3>
      <p>Your account is approved. You can now <a href="/submit" class="pill acid">Submit new quotes</a> to the dispenser.</p>
      <p class="hint" style="margin-top: 10px;">Below are your submitted quotes and their status. If a quote is rejected, you can edit and resubmit it.</p>
    </div>
  {% elif mode == 'users' %}
  {% if users %}
  {% for u in users %}
  <article class="card">
    <div class="user-info">
      <strong>{{ u.admin_name }}</strong> ({{ u.email }})
      <div class="quote-meta">
        <span class="pill {% if u.status == 'PENDING' %}hot{% elif u.status == 'APPROVED' %}acid{% endif %}">{{ u.status
          }}</span>
        <span class="pill">Joined: {{ u.created_at|format_datetime }}</span>
        {% if u.is_admin %}<span class="pill acid">ADMIN</span>{% endif %}
      </div>
    </div>
    <div class="actions" style="margin-top: 15px;">
      {% if u.status == 'PENDING' %}
      <form method="post" action="/admin/users/{{ u.email }}/approve" style="display: inline;">
        <button class="btn primary" type="submit">Approve</button>
      </form>
      <form method="post" action="/admin/users/{{ u.email }}/reject" style="display: inline;">
        <button class="btn danger" type="submit">Delete (Reject)</button>
      </form>
      {% else %}
      {% if not u.is_admin %}
      <form method="post" action="/admin/users/{{ u.email }}/reject" style="display: inline;">
        <button class="btn danger" type="submit">Delete User</button>
      </form>
      {% endif %}
      {% endif %}
    </div>
  </article>
  {% endfor %}
  {% else %}
  <div class="card">
    <h3>No users found</h3>
    <p class="hint">The user base is either non-existent or hiding.</p>
  </div>
  {% endif %}
  {% else %}
  
  {% if quotes and mode == 'moderation' %}
    <article class="card bulk-actions-card">
      <div style="display: flex; align-items: center; justify-content: space-between; gap: 15px;">
        <h3 style="margin: 0;">Bulk Actions ({{ quotes|length }} pending)</h3>
        <form method="post" action="/admin/bulk-update?mode={{ mode }}" style="display: flex; gap: 10px;">
          <button class="btn primary" type="submit" name="action" value="approve_all">Approve All</button>
          <button class="btn danger" type="submit" name="action" value="reject_all">Reject All</button>
        </form>
      </div>
    </article>
  {% endif %}

  {% if quotes %}
  {% for q in quotes %}
  <article class="card">
    {% if is_admin %}
    <form method="post" action="/admin/update/{{ q.id }}?mode={{ mode }}">
      <textarea name="content" class="quote admin-textarea" rows="2">{{ q.content }}</textarea>
      <div class="quote-meta">
        <span class="pill {% if q.status == 'PENDING' %}hot{% elif q.status == 'APPROVED' %}acid{% endif %}">{{ q.status }}</span>
        <span class="pill">by: <input name="submitted_by" value="{{ q.submitted_by }}" class="admin-inline-input" /></span>
        {% if q.created_at %}<span class="pill">at: {{ q.created_at|format_datetime }}</span>{% endif %}
      </div>
      <div class="actions">
        <button class="btn primary" type="submit" name="action" value="approve">Approve</button>
        <button class="btn danger" type="submit" name="action" value="reject">Reject</button>
        <button class="btn alt" type="submit" name="action" value="edit">Edit</button>
      </div>
    </form>
    {% else %}
    <form method="post" action="/admin/resubmit/{{ q.id }}">
      <textarea name="content" class="quote admin-textarea" {% if q.status != 'REJECTED' %}readonly{% endif %} rows="2">{{ q.content }}</textarea>
      <div class="quote-meta">
        <span class="pill {% if q.status == 'PENDING' %}hot{% elif q.status == 'APPROVED' %}acid{% else %}danger{% endif %}">{{ q.status }}</span>
        <span class="pill">by: {{ q.submitted_by }}</span>
        {% if q.created_at %}<span class="pill">at: {{ q.created_at|format_datetime }}</span>{% endif %}
      </div>
      {% if q.status == 'REJECTED' %}
      <div class="actions">
        <button class="btn primary" type="submit">Resubmit</button>
      </div>
      {% endif %}
    </form>
    {% endif %}
  </article>
  {% endfor %}
  {% else %}
  <div class="card">
    <h3>Queue cleared</h3>
    <p class="hint">No pending quotes. Either youâ€™re efficient, or nobody is submitting. Both are suspicious.</p>
    <div class="actions">
      <a class="btn alt" href="/">Back to home</a>
      <a class="btn primary" href="/submit">Add a quote</a>
    </div>
  </div>
  {% endif %}
  {% endif %}
</section>
{% endblock %}