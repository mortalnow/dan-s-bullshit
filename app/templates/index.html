{% extends "base.html" %}
{% block content %}
<section class="hero hero-slam">
  <div class="hero-content">
    <h2>Dan Quote Dispenser</h2>
    <p>One random quote at a time.</p>
    <div class="actions">
      <a class="btn alt" href="/submit">SUBMIT NEW</a>
      <button class="btn" id="openDonate"
        style="background: #a5c0ff; color: var(--ink); font-family: inherit; font-size: inherit;">Donate</button>
    </div>
  </div>
  <div class="hero-image">
    <img src="/static/images/hero-image-2.png" alt="Dan's Bullshit">
  </div>
</section>

<section class="grid two">
  <article class="poster">
    <button class="btn primary btn-poster-shuffle" id="shuffleBtn">Shuffle</button>
    <header class="poster-head">
      <div class="stamp">CERTIFIED</div>
    </header>

    {% if quote %}
    <blockquote class="quote-big" id="quoteDisplay">{{ quote.content }}</blockquote>
    {% else %}
    <div class="empty" id="emptyDisplay">
      <h3>No approved quotes yet</h3>
      <p class="hint">For local demo: run <code>uv run python scripts/import_records.py</code> then refresh.</p>
    </div>
    {% endif %}
  </article>

  <aside class="card sidebar">
    <h3>HOW TO PLAY</h3>
    <ul class="list">
      <li><strong>Shuffle:</strong> click "Shuffle" until you laugh.</li>
      <li><strong>Register:</strong> <a href="/register">create an account</a> to join.</li>
      <li><strong>Submit:</strong> once <span class="pill acid">APPROVED</span>, you can add quotes.</li>
      <li><strong>Approve:</strong> <span style="font-size: 0.85em;">open <a class="btn topbar-admin"
          href="/admin"
          style="font-size: 12px; display: inline-block; padding: 6px 10px;">ADMIN</a> and accept your destiny.</span></li>
    </ul>
    <div class="note">
      <div class="note-title">
        {% if settings.local_mode %}
        LOCAL MODE
        {% else %}
        PROD MODE
        {% endif %}
      </div>
    </div>
  </aside>
</section>

<!-- Donate Modal -->
<div id="donateModal" class="modal">
  <div class="modal-content card">
    <div class="modal-header">
      <h3>Support the Bullshit</h3>
      <button class="btn-close" id="closeDonate">&times;</button>
    </div>
    <div class="modal-body">
      <img src="/static/images/donate-qr.jpg" alt="Donate QR Code" class="donate-image">
      <p class="hint">Your support keeps the dispenser running and the wisdom flowing.</p>
    </div>
  </div>
</div>

<script>
  const modal = document.getElementById('donateModal');
  const btn = document.getElementById('openDonate');
  const span = document.getElementById('closeDonate');

  btn.onclick = function () {
    modal.style.display = 'flex';
  }

  span.onclick = function () {
    modal.style.display = 'none';
  }

  window.onclick = function (event) {
    if (event.target == modal) {
      modal.style.display = 'none';
    }
  }

  // Dynamic font sizing for quote to fit container
  function fitQuoteToContainer() {
    const quote = document.querySelector('.quote-big');
    if (!quote) return;
    
    const container = quote.parentElement;
    const isMobile = window.innerWidth <= 600;
    const maxSize = isMobile ? 20 : 48;
    const minSize = isMobile ? 12 : 14;
    
    let fontSize = maxSize;
    quote.style.fontSize = fontSize + 'px';
    
    while (quote.scrollHeight > quote.clientHeight && fontSize > minSize) {
      fontSize -= 1;
      quote.style.fontSize = fontSize + 'px';
    }
  }

  fitQuoteToContainer();
  window.addEventListener('resize', fitQuoteToContainer);

  // Shuffle button - fetch new quote without page refresh
  const shuffleBtn = document.getElementById('shuffleBtn');
  const quoteDisplay = document.getElementById('quoteDisplay');
  const emptyDisplay = document.getElementById('emptyDisplay');
  
  if (shuffleBtn) {
    shuffleBtn.addEventListener('click', async function() {
      // Disable button during fetch
      shuffleBtn.disabled = true;
      shuffleBtn.textContent = 'Loading...';
      
      try {
        const response = await fetch('/api/quotes/random');
        const quote = await response.json();
        
        if (quote && quote.content) {
          // Show quote, hide empty state
          if (emptyDisplay) {
            emptyDisplay.style.display = 'none';
          }
          
          // Create or update quote display
          if (!quoteDisplay) {
            const blockquote = document.createElement('blockquote');
            blockquote.className = 'quote-big';
            blockquote.id = 'quoteDisplay';
            blockquote.textContent = quote.content;
            const poster = document.querySelector('.poster');
            const header = document.querySelector('.poster-head');
            if (header && header.nextSibling) {
              poster.insertBefore(blockquote, header.nextSibling);
            } else {
              poster.appendChild(blockquote);
            }
          } else {
            quoteDisplay.textContent = quote.content;
            quoteDisplay.style.display = 'block';
          }
          
          // Recalculate font size for new quote
          setTimeout(fitQuoteToContainer, 10);
        } else {
          // No quote available - show empty state
          if (quoteDisplay) {
            quoteDisplay.style.display = 'none';
          }
          if (emptyDisplay) {
            emptyDisplay.style.display = 'block';
          } else {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'empty';
            emptyDiv.id = 'emptyDisplay';
            emptyDiv.innerHTML = '<h3>No approved quotes yet</h3><p class="hint">For local demo: run <code>uv run python scripts/import_records.py</code> then refresh.</p>';
            const poster = document.querySelector('.poster');
            const header = document.querySelector('.poster-head');
            if (header && header.nextSibling) {
              poster.insertBefore(emptyDiv, header.nextSibling);
            } else {
              poster.appendChild(emptyDiv);
            }
          }
        }
      } catch (error) {
        console.error('Error fetching quote:', error);
        alert('Failed to fetch quote. Please try again.');
      } finally {
        // Re-enable button
        shuffleBtn.disabled = false;
        shuffleBtn.textContent = 'Shuffle';
      }
    });
  }
</script>
{% endblock %}